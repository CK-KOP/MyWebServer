# 🌐 MyWebServer

一个基于 Linux 下 C++ 的高性能多线程 Web 服务器

## 📌 项目特性

- **高并发处理**
  - 使用 **线程池** 管理工作线程，提高并发能力
  - 采用 **非阻塞 socket** 结合 **epoll** 事件驱动（支持 ET 和 LT 模式）
  - 实现 **Reactor 模式** 和 **同步模拟 Proactor 模式** 的事件处理机制
  - 并发性能强，经 **Webbench 压力测试**，支持 **上万级别的高并发连接**
- **高效 HTTP 处理**
  - 采用 **有限状态机** 解析 HTTP 请求，支持 **GET / POST 请求**
  - 解析 HTTP 报文头和请求体，并根据请求返回静态资源或查询数据库
  - 支持静态资源访问（HTML、CSS、图片、视频等）
- **数据库支持**
  - **MySQL 连接池**，提高数据库连接效率，避免频繁创建销毁连接的开销
  - 提供 **用户注册、登录** 功能，可通过 web 页面访问数据库
- **定时器管理**
  - 基于 **set（红黑树）** 实现的定时器管理，自动关闭超时请求
  - 有效减少无效连接，释放系统资源
- **日志系统**
  - **同步/异步日志** 记录服务器运行状态
  - 支持按天生成日志文件，方便维护与分析
  - 异步日志基于队列实现，提高日志记录效率
- **性能优化**
  - 使用 **内存池** 管理连接对象，减少动态分配的开销
  - 互斥锁机制保证线程安全
  - 采用 **同步 I/O 模拟 Proactor 模式** 提高并发效率

## ⚙️ 技术栈

- **操作系统**: Linux
- **编程语言**: C++
- **网络编程**: `epoll`、`非阻塞 IO`、`Reactor/Proactor`
- **多线程**: `pthread`、`线程池`
- **数据库**: MySQL (`MySQL 连接池`)
- **数据结构**: `set`（定时器）、`队列`（异步日志）
- **同步机制**: `互斥锁`、`条件变量`、`信号量`
- **日志管理**: `同步/异步日志系统`

## 📦 代码结构

```
├── config.cpp/h          # 服务器配置实现
├── http/                 # HTTP 连接处理模块
│   ├── http_conn.cpp     # HTTP 连接实现
│   └── http_conn.h       # HTTP 连接定义
├── lock/                 # 线程同步机制
│   └── locker.h          # 互斥锁、条件变量、信号量封装
├── log/                  # 日志系统
│   ├── block_queue.h     # 阻塞队列实现（异步日志）
│   ├── log.cpp           # 日志实现
│   └── log.h             # 日志类定义
├── mydb/                 # 数据库连接池
│   ├── sql_connection_pool.cpp  # 连接池实现
│   └── sql_connection_pool.h    # 连接池定义
├── threadpool/           # 线程池模块
│   └── threadpool.h      # 线程池模板类实现
├── timer/                # 定时器模块
│   ├── lst_timer.cpp     # 定时器实现
│   └── lst_timer.h       # 定时器定义
├── webserver.cpp/h       # Web 服务器核心类
├── main.cpp              # 服务器主程序入口
├── Makefile              # 编译脚本
└── root/                 # 静态资源目录
    ├── *.html            # 各种网页文件
    ├── *.gif/jpg         # 图片资源
    └── *.mp4             # 视频资源
```

## 🚀 功能展示

服务器提供以下主要功能：

- 用户注册与登录
- 图片展示功能
- 视频播放功能

## 🛠️ 配置与运行

### 配置参数

服务器支持以下配置参数：

| 参数 | 描述                                               | 默认值 |
| ---- | -------------------------------------------------- | ------ |
| `-p` | 端口号                                             | 9006   |
| `-l` | 日志写入方式（0:同步，1:异步）                     | 0      |
| `-m` | 触发组合模式（0:LT+LT, 1:LT+ET, 2:ET+LT, 3:ET+ET） | 0      |
| `-o` | 优雅关闭连接（0:不使用, 1:使用）                   | 0      |
| `-s` | 数据库连接池数量                                   | 8      |
| `-t` | 线程池内线程数量                                   | 8      |
| `-c` | 是否关闭日志（0:不关闭, 1:关闭）                   | 0      |
| `-a` | 并发模型选择（0:Proactor, 1:Reactor）              | 0      |

### 运行前准备

1. 确保安装了 MySQL 数据库，并创建相应的数据库和表

2. 修改 main.cpp 中的数据库连接信息：

   ```cpp
   string user = "your_username";         // 数据库用户名
   string passwd = "your_password";       // 数据库密码
   string databasename = "your_dbname";   // 数据库名
   ```

### 编译与运行

```bash
# 编译
make

# 运行（使用默认参数）
./server

# 运行（指定参数）
./server -p 9007 -l 1 -m 3 -t 16 -s 16 -a 1

# 示例：端口9007，异步日志，ET+ET触发模式，16线程，16数据库连接，Reactor模型
./server -p 9007 -l 1 -m 3 -t 16 -s 16 -a 1
```

### 服务器初始化流程

1. 解析命令行参数
2. 初始化服务器配置
3. 初始化日志系统
4. 初始化数据库连接池
5. 初始化线程池
6. 设置触发模式
7. 启动监听
8. 进入事件循环

## 📊 性能测试

使用 Webbench 进行压力测试，在单机环境下可支持上万并发连接：

```bash
# 安装 Webbench
cd test_pressure/webbench-1.5
make
make install

# 执行压力测试
webbench -c [并发连接数] -t [运行时间] http://[服务器IP]:[端口]/
```

### 压力测试结果

服务器在高并发条件下表现出色，以下是一个典型的压力测试结果：

- Proactor  LT + LT

```
webbench -c 8000 -t 5 http://127.0.0.1:9006/
Webbench - Simple Web Benchmark 1.5
Copyright (c) Radim Kolar 1997-2004, GPL Open Source Software.

Benchmarking: GET http://127.0.0.1:9006/
8000 clients, running 5 sec.

Speed=823860 pages/min, 1537872 bytes/sec.
Requests: 68655 susceed, 0 failed.
```

测试环境下，服务器能够同时处理 8000 个并发连接，5 秒内成功处理了 68655 个请求，无失败请求，平均每分钟处理 823860 个页面，传输速度达到 1537872 字节/秒。

## 📝 待改进

-  支持 HTTPS 协议
-  实现 HTTP/2 特性
-  优化文件传输性能
-  添加更多数据库功能
-  实现分布式部署支持
-  增加负载均衡功能

## 🙏 致谢

本项目的实现是基于学习和参考 [qinguoyi/TinyWebServer](https://github.com/qinguoyi/TinyWebServer) 项目。感谢原作者的开源精神和优秀代码，让我能够通过学习、模仿和实践，更好地理解 Web 服务器的工作原理和实现技术。项目中的许多思路和实现方式都来源于这个优秀的开源项目。